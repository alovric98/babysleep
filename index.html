<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Sleep Logic ¬∑ v2.6</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,400&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #FDF8F3; --bg-card: rgba(255, 252, 249, 0.88); --text-1: #2C2420; --text-2: #7A6E6A; --text-3: #B0A8A4;
  --rose: #C9848A; --rose-ll: #FBF2F3; --lav: #9B7BB0; --lav-l: #EAE4F4; --sage: #6A9E7A; --sage-ll: #EFF8ED;
  --gold: #C4913A; --gold-ll: #FDF6E8; --shadow-sm: 0 2px 14px rgba(44, 36, 32, 0.08); --radius: 20px;
}
*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text-1); min-height: 100vh; overflow-x: hidden; line-height: 1.5; }
body::before { content: ''; position: fixed; inset: 0; background: radial-gradient(ellipse 80% 50% at 15% 10%, rgba(232,180,184,0.2) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 85% 80%, rgba(200,187,219,0.15) 0%, transparent 55%); pointer-events: none; }
.app { position: relative; max-width: 430px; margin: 0 auto; padding-bottom: 60px; }

/* HEADER */
.header { padding: 50px 20px 25px; display: flex; align-items: flex-start; justify-content: space-between; }
.header-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #F5D9DB, #EAE4F4); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 6px 20px rgba(201,132,138,0.2); }
.header h1 { font-family: 'Fraunces', serif; font-weight: 300; font-size: 28px; }
.header h1 em { color: var(--rose); font-style: italic; }
.header-sub { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-3); margin-top: 6px; opacity: 0.8; line-height: 1.4; }

.lang-toggle { display: flex; background: #FFF; border: 1px solid var(--rose-ll); border-radius: 30px; padding: 3px; }
.lang-btn { border: none; background: transparent; font-size: 11px; font-weight: 700; color: var(--text-3); padding: 5px 12px; border-radius: 20px; cursor: pointer; }
.lang-btn.active { background: linear-gradient(135deg, var(--rose), var(--lav)); color: white; }

/* INPUT CARDS */
.card { background: var(--bg-card); backdrop-filter: blur(15px); border: 1px solid rgba(201,132,138,0.1); border-radius: var(--radius); padding: 18px; margin: 0 14px 12px; box-shadow: var(--shadow-sm); }
.card-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-3); margin-bottom: 12px; }
.age-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
.age-btn { border: none; background: var(--rose-ll); border-radius: 12px; padding: 10px 0; cursor: pointer; transition: 0.2s; }
.age-btn .num { display: block; font-size: 17px; font-weight: 800; color: var(--rose); }
.age-btn .unit { font-size: 9px; color: var(--text-3); font-weight: 700; text-transform: uppercase; }
.age-btn.active { background: linear-gradient(135deg, var(--rose), var(--lav)); transform: scale(1.05); }
.age-btn.active .num, .age-btn.active .unit { color: white; }
.ww-hint { margin-top: 10px; padding: 6px; background: var(--rose-ll); border-radius: 10px; font-size: 11px; color: var(--rose); text-align: center; font-weight: 600; }

input[type="time"] { border: none; background: transparent; font-family: inherit; font-size: 28px; font-weight: 700; color: var(--text-1); outline: none; width: 100%; }
/* SAKRIVANJE AM/PM OZNAKE */
input[type="time"]::-webkit-datetime-edit-ampm-field { display: none; }
input[type="time"]::-moz-time-text { display: none; }

.nap-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.nap-val { font-size: 38px; font-weight: 800; color: var(--rose); }
.nap-val sup { font-size: 14px; color: var(--text-3); }
.nap-pill { font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }
.nap-pill.good { background: #D8EDD4; color: #5E9E74; }
.nap-pill.micro { background: #FDE8E8; color: #B83030; }
input[type="range"] { -webkit-appearance: none; width: 100%; height: 5px; background: #EEE; border-radius: 5px; outline: none; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #FFF; border: 2px solid var(--rose); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

.calc-btn { width: calc(100% - 28px); margin: 0 14px 15px; padding: 18px; background: linear-gradient(135deg, var(--rose), var(--lav)); color: #FFF; border: none; border-radius: var(--radius); font-weight: 800; font-size: 16px; cursor: pointer; box-shadow: 0 8px 20px rgba(201,132,138,0.3); }

/* RESULTS */
.results { display: none; margin-bottom: 20px; }
.results.visible { display: block; animation: slideUp 0.4s ease forwards; }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 14px 12px; }
.res-card { padding: 15px; border-radius: var(--radius); border: 1px solid #FFF; box-shadow: var(--shadow-sm); }
.res-card.target { background: #F9E8EA; } .res-card.reset { background: #E8F0E8; }
.res-card label { font-size: 9px; font-weight: 700; color: var(--text-3); text-transform: uppercase; display: block; margin-bottom: 4px; }
.res-card .time { font-size: 28px; font-weight: 800; }
.countdown-card { background: #2C2420; border-radius: var(--radius); padding: 20px; margin: 0 14px 12px; color: #FFF; transition: 1s; }
.countdown-card.pulse { background: #6A9E7A !important; animation: pulse 2s infinite alternate; }
@keyframes pulse { from { opacity: 0.8; } to { opacity: 1; } }
.cd-time { font-size: 42px; font-weight: 700; line-height: 1; }
.cd-phase { font-size: 10px; text-transform: uppercase; color: rgba(255,255,255,0.5); font-weight: 700; margin-bottom: 5px; }
.advice-card { background: var(--gold-ll); padding: 18px; border-radius: var(--radius); margin: 0 14px 12px; border: 1px solid rgba(196,145,58,0.1); }
.adv-text { font-size: 12px; color: var(--text-2); line-height: 1.6; }
.new-btn { width: calc(100% - 28px); margin: 0 14px 20px; padding: 12px; background: transparent; border: 1px solid var(--rose-ll); border-radius: 15px; color: var(--text-3); font-weight: 700; font-size: 13px; cursor: pointer; }

/* JOURNAL */
.journal-section { display: none; margin: 0 14px 40px; }
.journal-section.visible { display: block; }
.section-divider { margin: 20px 0 12px; display: flex; align-items: center; gap: 10px; color: var(--text-3); font-size: 10px; font-weight: 700; text-transform: uppercase; }
.section-divider::after { content: ''; flex: 1; height: 1px; background: #EEE; }

/* NOVI IZGLED DNEVNIKA S PADAJUƒÜIM IZBORNIKOM */
.date-select {
  width: 100%; 
  padding: 12px 16px; /* Poveƒáan lijevi padding na 16px */
  border-radius: 12px; 
  border: 1px solid var(--border);
  background: var(--rose-ll); 
  color: var(--rose); 
  font-weight: 800; 
  font-size: 14px;
  margin-bottom: 12px; 
  outline: none; 
  cursor: pointer; 
  text-align: left; /* Promijenjeno s center na left */
  font-family: inherit;
  appearance: none; /* Uklanja sistemsku strelicu na nekim mobitelima za ƒçi≈°ƒái look */
  -webkit-appearance: none;
}

.journal-entry { background: #FFF; border-radius: 15px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
.entry-time { font-size: 18px; font-weight: 700; }
.entry-details { font-size: 10px; color: var(--text-3); font-weight: 600; }
.del-btn { border: none; background: #FDF2F3; color: var(--rose); width: 26px; height: 26px; border-radius: 50%; font-weight: 800; cursor: pointer; }

.footer { text-align: center; padding: 24px 28px 32px; font-size: 11px; color: var(--text-3); line-height: 1.7; }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-left">
      <div class="header-icon">üåô</div>
      <h1 data-i18n-html="title">Prozor <em>Budnosti</em></h1>
      <p class="header-sub">Borb√©ly, A. A. (1982). A two process model of sleep regulation. <em>Human Neurobiology</em>, 1(3).</p>
    </div>
    <div class="lang-toggle">
      <button class="lang-btn active" id="btnHR" onclick="setLang('hr')">HR</button>
      <button class="lang-btn" id="btnEN" onclick="setLang('en')">EN</button>
    </div>
  </div>

  <div class="card">
    <label class="card-label" data-i18n="labelAge">Starost djeteta (mjeseci)</label>
    <div class="age-grid" id="ageGrid"></div>
    <div class="ww-hint" id="wwHint"></div>
  </div>

  <div class="card">
    <div class="time-field">
      <div class="time-icon">‚è∞</div>
      <div style="flex:1">
        <label class="card-label" style="margin:0; font-size:9px" data-i18n="labelWake">Beba se probudila u</label>
        <input type="time" id="wakeTime" required lang="en-GB" onchange="save()">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="nap-header">
      <div class="nap-val" id="napVal">45<sup>min</sup></div>
      <span class="nap-pill good" id="napPill">‚úì Dobar san</span>
    </div>
    <input type="range" id="napSlider" min="1" max="120" value="45" oninput="onSlide(this)">
    <div class="slider-labels" style="display:flex; justify-content:space-between; font-size:9px; color:#B0A8A4; margin-top:5px">
      <span>1m</span><span>30</span><span>45</span><span>60</span><span>90</span><span>2h</span>
    </div>
  </div>

  <button class="calc-btn" onclick="calc()" data-i18n="btnCalc">Izraƒçunaj Prozor Spavanja</button>

  <div class="results" id="res">
    <div class="res-grid">
      <div class="res-card target">
        <label data-i18n="rcTarget">Idealno u</label>
        <div class="time" id="tTime">--:--</div>
      </div>
      <div class="res-card reset">
        <label data-i18n="rcReset">Reset od</label>
        <div class="time" id="rTime">--:--</div>
      </div>
    </div>
    <div class="countdown-card" id="cdCard">
      <div class="cd-phase" id="cdP">‚è≥ GRADI SE ADENOZIN</div>
      <div class="cd-time" id="cdT">00:00</div>
    </div>
    <div class="advice-card"><div class="adv-text" id="adv"></div></div>
    <button class="new-btn" onclick="resetUI()" data-i18n="btnNew">‚Ü© Novi izraƒçun</button>
  </div>

  <div class="journal-section" id="jSection">
    <div class="section-divider" data-i18n="secJournal">Dnevnik spavanja</div>
    <select id="jDateSelect" class="date-select" onchange="renderJList()"></select>
    <div id="jList"></div>
  </div>

  <div class="footer">
    <strong data-i18n="footerModel">Model dva procesa (Borb√©ly, 1982)</strong><br>
    <em data-i18n="footerDiscl">Ovo nije medicinski savjet.</em>
  </div>
</div>

<script>
const WW = {3:{min:75,max:105},4:{min:90,max:120},5:{min:105,max:135},6:{min:120,max:165},7:{min:150,max:195},8:{min:150,max:210},9:{min:180,max:225},10:{min:180,max:240},11:{min:195,max:240},12:{min:195,max:240}};
const L = {
  hr: {
    title: 'Prozor <em>Budnosti</em>', labelAge: 'Starost (mjeseci)', labelWake: 'Beba se probudila u', btnCalc: 'Izraƒçunaj Prozor Spavanja', rcTarget: 'Idealno spavanje u', rcReset: 'Postupno uspavljivanje u', secJournal: 'Dnevnik spavanja', btnNew: '‚Ü© Novi izraƒçun', ageU: 'mj.',
    phases: {s:'üå± Adenozin raste', r:'üåø Low-Stim Reset', n:'üî¥ Savr≈°eno vrijeme'},
    adv0: '<strong>La≈æni san (<10m)</strong>. Adenozin nije oƒçi≈°ƒáen. Pritisak sna ostaje na maksimumu. Poku≈°ajte ponovno uspavati bebu za 20 minuta.',
    adv1: 'Beba je imala <strong>mikro-san (< 30 min)</strong> ‚Äî nakupila je manje adenozina nego pri punom ciklusu. Prozor budnosti je skraƒáen za <strong>%P%</strong> kako bismo sprijeƒçili <strong>kortizolski vrh</strong>. Premoreni mozak luƒçi stres-hormone koji ote≈æavaju spavanje.',
    adv2: 'San od <strong>30‚Äì45 min</strong> odgovara jednom REM ciklusu ‚Äî adenozin je djelomiƒçno resetiran. Smanjujemo prozor za <strong>10%</strong> kako bismo uhvatili optimalni adenozinski prag bez aktivacije kortizola.',
    adv3: 'Beba je spavala <strong>dovoljno (> 45 min)</strong> ‚Äî adenozin je dobro resetiran. Koristimo <strong>puni bazni prozor</strong> za ovu dob. Prerano nametanje sna = otpor i plakanje. Prekasno = kortizolski vrh i pretjerani umor.'
  },
  en: {
    title: 'Wake <em>Window</em>', labelAge: 'Baby\'s Age (mo.)', labelWake: 'Baby woke up at', btnCalc: 'Calculate Window', rcTarget: 'Ideal sleep time', rcReset: 'Start soothing from', secJournal: 'Sleep Journal', btnNew: '‚Ü© New Calculation', ageU: 'mo.',
    phases: {s:'üå± Building adenosine', r:'üåø Low-Stim Reset', n:'üî¥ Perfect moment'},
    adv0: '<strong>False start (<10m)</strong>. Adenosine was not cleared. Sleep pressure remains high. Attempt again in 20 min.',
    adv1: 'Baby had a <strong>micro-nap (< 30 min)</strong> ‚Äî less adenosine cleared. Window shortened by <strong>%P%</strong> to prevent a <strong>cortisol spike</strong>. Overtired brain releases stress hormones.',
    adv2: 'A <strong>30‚Äì45 min</strong> nap equals one REM cycle ‚Äî partial reset. We reduce window by <strong>10%</strong> to hit the optimal threshold without triggering cortisol.',
    adv3: 'Baby slept <strong>enough (> 45 min)</strong> ‚Äî adenosine was well reset. We use the <strong>full base window</strong> for this age. Too early = resistance. Too late = cortisol fight.'
  }
};
let cur = 'hr', sel = 3, interval = null;

function setLang(l) {
  cur = l; localStorage.setItem('lang', l);
  document.getElementById('btnHR').classList.toggle('active', l==='hr');
  document.getElementById('btnEN').classList.toggle('active', l==='en');
  document.querySelectorAll('[data-i18n]').forEach(e => e.textContent = L[l][e.dataset.i18n]);
  document.querySelectorAll('[data-i18n-html]').forEach(e => e.innerHTML = L[l][e.dataset.i18nHtml]);
  renderGrid(); renderJ();
}

function renderGrid() {
  const g = document.getElementById('ageGrid'); g.innerHTML = '';
  for(let i=3; i<=12; i++) {
    const b = document.createElement('button'); b.className = 'age-btn'+(i===sel?' active':'');
    b.innerHTML = `<span class="num">${i}</span><span class="unit">${L[cur].ageU}</span>`;
    b.onclick = () => { sel=i; renderGrid(); updHint(); save(); };
    g.appendChild(b);
  }
  updHint();
}

function updHint() { document.getElementById('wwHint').textContent = `${L[cur].labelAge}: ${WW[sel].min}-${WW[sel].max}m`; }

function onSlide(el) {
  const v = el.value; document.getElementById('napVal').innerHTML = `${v}<sup>min</sup>`;
  const p = document.getElementById('napPill');
  p.className = 'nap-pill ' + (v<30?'micro':'good');
  p.textContent = v<10?'üö´ False Start' : (v<30?(cur==='hr'?'‚ö° Mikro-san':'‚ö° Micro-nap'):(cur==='hr'?'‚úì Dobar san':'‚úì Good nap'));
}

function calc() {
  const w = document.getElementById('wakeTime').value; if(!w) return;
  const n = parseInt(document.getElementById('napSlider').value);
  let factor = n<10?0:(n<=20?0.5:(n<=30?0.8:(n<=45?0.9:1)));
  const [h, m] = w.split(':').map(Number);
  const wakeD = new Date(); wakeD.setHours(h, m, 0); if(wakeD > new Date()) wakeD.setDate(wakeD.getDate()-1);
  
  let target, resetT, adv;
  if(factor === 0) { target = new Date(wakeD.getTime() + 20*60000); adv = L[cur].adv0; }
  else {
    let ww = Math.round(((WW[sel].min + WW[sel].max)/2)*factor);
    if(sel===3 && n<30) ww = 60;
    target = new Date(wakeD.getTime() + ww*60000);
    adv = n<30?L[cur].adv1.replace('%P%', factor===0.5?'50%':'20%') : (n<=45?L[cur].adv2:L[cur].adv3);
  }
  resetT = new Date(target.getTime() - 15*60000);
  document.getElementById('tTime').textContent = fmt(target);
  document.getElementById('rTime').textContent = fmt(resetT);
  document.getElementById('adv').innerHTML = adv;
  document.getElementById('res').classList.add('visible');
  startCd(target, resetT);
  saveJ({id:Date.now(), ts:Date.now(), w, t:fmt(target), age:sel, nap:n});
}

function startCd(target, resetT) {
  if(interval) clearInterval(interval);
  function tick() {
    const diff = target - new Date();
    if(diff <= 0) { clearInterval(interval); document.getElementById('cdT').textContent = "00:00"; document.getElementById('cdCard').classList.add('pulse'); return; }
    const mins = Math.floor(diff/60000); const secs = Math.floor((diff%60000)/1000);
    document.getElementById('cdT').textContent = `${pad(mins)}:${pad(secs)}`;
    let p = L[cur].phases.s; if(new Date() > resetT) p = L[cur].phases.r; if(mins < 2) p = L[cur].phases.n;
    document.getElementById('cdP').textContent = p;
  }
  tick(); interval = setInterval(tick, 1000);
}

function resetUI() {
  if(interval) clearInterval(interval); document.getElementById('res').classList.remove('visible');
  document.getElementById('cdCard').classList.remove('pulse');
  const now = new Date(); document.getElementById('wakeTime').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
}

/* LOGIKA DNEVNIKA (7 DANA, GRUPIRANJE PO DATUMU, DROPDOWN) */
function getJ() { try { return JSON.parse(localStorage.getItem('j') || '[]'); } catch { return []; } }

function getDStr(ts) {
  const d = new Date(ts || Date.now()); // Fallback za stare unose bez ts
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}.`;
}

function saveJ(e) { 
  let j = getJ(); j.unshift(e); 
  // Zadr≈æavamo samo zadnjih 7 dana koristeƒái apsolutno vrijeme (milisekunde)
  const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
  j = j.filter(x => (x.ts || Date.now()) >= sevenDaysAgo);
  localStorage.setItem('j', JSON.stringify(j)); renderJ(); 
}

function del(id) { const j = getJ().filter(x=>x.id!==id); localStorage.setItem('j', JSON.stringify(j)); renderJ(); }

function renderJ() {
  const j = getJ(); 
  const section = document.getElementById('jSection');
  const select = document.getElementById('jDateSelect');
  
  if(j.length === 0) { section.classList.remove('visible'); return; }
  section.classList.add('visible');

  // Izvlaƒçenje unikatnih datuma (najnoviji prvi)
  const dates = [...new Set(j.map(x => getDStr(x.ts)))];
  const currentSel = select.value;

  select.innerHTML = dates.map(d => {
    const isToday = d === getDStr(Date.now());
    return `<option value="${d}">üìÖ ${isToday ? 'Danas ('+d+')' : d}</option>`;
  }).join('');

  // Zadr≈æi odabir ako postoji, inaƒçe prika≈æi najnoviji datum (dana≈°nji)
  if (dates.includes(currentSel)) select.value = currentSel;
  else select.value = dates[0];

  renderJList();
}

function renderJList() {
  const j = getJ();
  const selDate = document.getElementById('jDateSelect').value;
  const list = document.getElementById('jList');
  
  const filtered = j.filter(x => getDStr(x.ts) === selDate);

  list.innerHTML = filtered.map(x => `
    <div class="journal-entry">
      <div>
        <div class="entry-time">${x.w} ‚Üí ${x.t}</div>
        <div class="entry-details">${x.age}${L[cur].ageU} ¬∑ ${x.nap}m sna</div>
      </div>
      <button class="del-btn" onclick="del(${x.id})">‚úï</button>
    </div>`).join('');
}

function save() { localStorage.setItem('state', JSON.stringify({sel, n:document.getElementById('napSlider').value, ts:Date.now()})); }
function pad(n) { return String(n).padStart(2,'0'); }
function fmt(d) { return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }

(function init() {
  const s = JSON.parse(localStorage.getItem('state')); if(s && Date.now()-s.ts < 86400000) { sel=s.sel; document.getElementById('napSlider').value=s.n; }
  const now = new Date(); document.getElementById('wakeTime').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  setLang(localStorage.getItem('lang') || 'hr');
})();
</script>
</body>
</html>
